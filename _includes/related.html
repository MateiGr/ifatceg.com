{% assign first_tag = page.tags | first %}
{% assign related_posts = site.posts | where_exp: "post", "post.tags.first == first_tag" | limit: 5 %}

{% assign exclude_urls = "" %}
{% if page.url %}
  {% assign exclude_urls = exclude_urls | append: page.url %}
{% endif %}

{% if related_posts.size > 0 %}
  {% for post in related_posts %}
    {% if post.url == page.url %}
      {% assign exclude_urls = exclude_urls | append: post.url %}
    {% endif %}
  {% endfor %}
  {% if exclude_urls != "" %}
    {% assign related_posts = related_posts | where_exp: "post", "exclude_urls contains post.url" %}
  {% endif %}
  {% if related_posts.size > 0 %}
    <div class="related-posts">
      <h3>Other posts about {{ first_tag }}:</h3>
      <ul>
        {% for post in related_posts %}
          <li><a href="{{ post.url }}">{{ post.title }}</a></li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endif %}
